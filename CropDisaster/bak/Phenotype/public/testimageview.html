<!DOCTYPE html>
<html lang="en">

<head>
    <title>피노타이핑 데이터 분석 가시화 시스템</title>
    <!-- HTML5 Shim and Respond.js IE10 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 10]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
      <![endif]-->
    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Mega Able Bootstrap admin template made using Bootstrap 4 and it has huge amount of ready made feature, UI components, pages which completely fulfills any dashboard needs." />
    <meta name="keywords" content="bootstrap, bootstrap admin template, admin theme, admin dashboard, dashboard template, admin template, responsive" />
    <meta name="author" content="codedthemes" />
    <!-- Favicon icon -->
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <!-- Google font-->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500" rel="stylesheet">
    <!-- waves.css -->
    <link rel="stylesheet" href="assets/pages/waves/css/waves.min.css" type="text/css" media="all">
    <!-- Required Fremwork -->
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap/css/bootstrap.min.css">
    <!-- waves.css -->
    <link rel="stylesheet" href="assets/pages/waves/css/waves.min.css" type="text/css" media="all">
    <!-- themify icon -->
    <link rel="stylesheet" type="text/css" href="assets/icon/themify-icons/themify-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" type="text/css" href="assets/icon/font-awesome/css/font-awesome.min.css">
    <!-- scrollbar.css -->
    <link rel="stylesheet" type="text/css" href="assets/css/jquery.mCustomScrollbar.css">
    <!-- am chart export.css -->
    <link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />
    <!-- Style.css -->
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.11.3/datatables.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" rel="stylesheet" />
    <style>
        .modal-dialog.modal-fullsize {
            max-width: 1920px !important;
            width: 100%;
            height: 100%;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .modal-content.modal-fullsize {
            height: auto;
            min-height: 100%;
            border-radius: 0;
        }
    </style>
</head>

<body>
    <!-- Pre-loader start -->
    <div class="theme-loader">
        <div class="loader-track">
            <div class="preloader-wrapper">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-yellow">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-green">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pre-loader end -->
    <div id="pcoded" class="pcoded">
        <div class="pcoded-overlay-box"></div>
        <div class="pcoded-container navbar-wrapper">
            <nav class="navbar header-navbar pcoded-header">
                <div class="navbar-wrapper">
                    <div class="navbar-logo">
                        <a class="mobile-menu waves-effect waves-light" id="mobile-collapse" href="#!">
                            <i class="ti-menu"></i>
                        </a>
                        <div class="mobile-search waves-effect waves-light">
                            <div class="header-search">
                                <div class="main-search morphsearch-search">
                                    <div class="input-group">
                                        <span class="input-group-addon search-close"><i class="ti-close"></i></span>
                                        <input type="text" class="form-control" placeholder="Enter Keyword">
                                        <span class="input-group-addon search-btn"><i class="ti-search"></i></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="/">
                            <h5>메인화면</h5>
                        </a>
                        <a class="mobile-options waves-effect waves-light">
                            <i class="ti-more"></i>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="pcoded-main-container">
                <div class="pcoded-wrapper">
                    <nav class="pcoded-navbar">
                        <div class="sidebar_toggle"><a href="#"><i class="icon-close icons"></i></a></div>
                        <div class="pcoded-inner-navbar main-menu">


                            <div class="pcoded-navigation-label" data-i18n="nav.category.navigation">Layout</div>
                            <ul class="pcoded-item pcoded-left-item">


                                <li>
                                    <a href="/" class="waves-effect waves-dark">
                                        <span class="pcoded-micon"><i class="ti-home"></i><b>D</b></span>
                                        <span class="pcoded-mtext" data-i18n="nav.dash.main">연구 정리</span>
                                        <span class="pcoded-mcaret"></span>
                                    </a>
                                </li>

                                <li>
                                    <a href="/search" class="waves-effect waves-dark">
                                        <span class="pcoded-micon"><i class="ti-search"></i><b>D</b></span>
                                        <span class="pcoded-mtext" data-i18n="nav.dash.main">연구 검색</span>
                                        <span class="pcoded-mcaret"></span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </nav>
                    <div class="pcoded-content">
                        <!-- Page-header start -->
                        <div class="page-header">
                            <div class="page-block">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="page-header-title">
                                            <h5 class="m-b-10">피노타이핑 데이터 분석 및 가시화 시스템</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <ul class="breadcrumb-title">
                                            <li class="breadcrumb-item">
                                                <a href="/"> <i class="fa fa-home"></i> </a>
                                            </li>
                                            <li class="breadcrumb-item"><a href="#!">다중 이미지</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="main-body">
                            <div class="page-wrapper">
                                <!-- Page-body start -->
                                <div class="page-body">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5>연구 설정</h5>
                                                </div>
                                                <div class="card-block">
                                                    <div class="form-group row">
                                                        <div class="col-sm-4">
                                                            <div class="row d-flex justify-content-between" style="margin-left: 0px; margin-right: 0px; margin-bottom: 10px;">
                                                                <h3 class="col">Label 선택</h3>
                                                                <button id="labelButton" onclick='selectAll(this.id)' class="btn btn-primary waves-effect waves-light" style="float: right; padding-bottom: 3px; padding-top: 3px;">전체선택</button>
                                                            </div>
                                                            <!-- label div start -->
                                                            <div class="form-control" id="label" style="overflow-y:scroll; height: 210px;">
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-4">
                                                            <div class="form-group">
                                                                <div class="row d-flex justify-content-between" style="margin-left: 0px; margin-right: 0px; margin-bottom: 10px;">
                                                                    <h3>각도</h3>
                                                                    <button id="angleButton" onclick='selectAll(this.id)' class="btn btn-primary waves-effect waves-light" value="angBox" style="float: right; padding-bottom: 3px; padding-top: 3px;">전체선택</button>
                                                                </div>
                                                                <div class="form-control" id="angle">
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-4">
                                                            <div class="form-group">
                                                                <div class="row d-flex justify-content-between" style="margin-left: 0px; margin-right: 0px; margin-bottom: 10px;">
                                                                    <h3>보기 선택</h3>

                                                                    <label style="display: flex; align-items: center; float: right;"><input type="radio" name="radio_btn" checked="checked" value="1">&nbsp;개별보기</label>
                                                                    <label style="display: flex; align-items: center; float: right;"><input type="radio" name="radio_btn" value="2">&nbsp;평균보기</label>
                                                                    <button id="dataButton" onclick='selectAll(this.id)' class="btn btn-primary waves-effect waves-light" style="float: right; padding-bottom: 3px; padding-top: 3px;">전체선택</button>
                                                                </div>
                                                                <div class="form-control">
                                                                    <div class="row">
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_1"> 수치데이터 테이블</label>
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_2"> 색상 차트 </label>
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_3"> 환경정보 차트 </label>
                                                                    </div>
                                                                    <div class="row">
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_4"> long axis 차트 </label>
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_5"> Short axis 차트 </label>
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_6"> Area 차트 </label>
                                                                    </div>
                                                                    <div class="row">
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_7"> Convex area 차트 </label>
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_8"> Center X 차트 </label>
                                                                        <label class="col-sm-4"><input type="checkbox" name="dataBox" id="datacheck_9"> Center Y 차트 </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- form end -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- image start -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>이미지</h5>
                                            <div class="card-block" style="overflow-x: scroll;">
                                                <!-- <div class="form-group" id="loadimg" style="white-space: nowrap; overflow-x:scroll; width: inherit; "> -->

                                                <!-- </div> -->

                                                <table class="table table-hover cell-border text-align: center" id="imgTable">

                                                </table>

                                            </div>
                                            <div class="card-block">
                                                <input id="ex6" type="text" style="width: 100%;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- image end -->


                                    <!-- table start -->
                                    <div class="card" style="display: block" id="table_div">
                                        <div class="card-header">
                                            <h5>수치데이터 테이블</h5>
                                            <div class="card-header-right">
                                                <ul class="list-unstyled card-option">
                                                    <li><i class="fa fa fa-wrench open-card-option"></i></li>
                                                    <li><i class="fa fa-window-maximize full-card"></i></li>
                                                    <li><i class="fa fa-minus minimize-card"></i></li>
                                                    <li><i class="fa fa-refresh reload-card"></i></li>
                                                    <li><i class="fa fa-trash close-card"></i></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="card-block table-border-style">
                                            <div class="table-responsive">
                                                <table class="table table-hover cell-border text-center " id="tableId">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>라벨</th>
                                                            <th>각도</th>
                                                            <th>Long axis</th>
                                                            <th>Short axis</th>
                                                            <th>area</th>
                                                            <th>Convex area</th>
                                                            <th>Center X</th>
                                                            <th>Center Y</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="table_body">

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- table end -->

                                    <!-- chart start -->
                                    <div class="row">
                                        <div class="col-sm-12" id="phenotypeCard">
                                            <div class="card" id="colorCard">
                                                <div class="card-header">
                                                    <h5>color</h5>
                                                    <div class="card-header-right">
                                                        <ul class="list-unstyled card-option">
                                                            <li><i class="fa fa fa-wrench open-card-option"></i></li>
                                                            <li><i class="fa fa-window-maximize full-card"></i></li>
                                                            <li><i class="fa fa-minus minimize-card"></i></li>
                                                            <li><i class="fa fa-refresh reload-card"></i></li>
                                                            <li><i class="fa fa-trash close-card"></i></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="card-block">
                                                    <div class="collapse show" id="chart2">
                                                        <div class="col" style="border: 1px solid lightgray; padding: 15px; margin-bottom: 5px;">
                                                            <canvas id="colorChart" style="height: 35vh; width: 100%;"></canvas>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-block row" style="margin-left: 0px; margin-right: 0px; margin-bottom: 10px;">
                                                    <label class="col-sm-5">녹색 값<input id="hueGreen" type="text" style="width: 100%;"></label>
                                                    <label class="col-sm-5">노란색 값<input id="hueYellow" type="text" style="width: 100%;"></label>
                                                    <label class="col-sm-1"></label>
                                                    <button class="btn btn-primary waves-effect waves-light col-sm-1" onclick="updateColorChart()" id="upload_button">계산</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- chart end -->
                                </div>
                            </div>
                        </div>


                        <!-- Page-header end -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-fullsize" role="document">
            <div class="modal-content modal-fullsize">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel"></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fa fa-times fa-3x"></i></button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <img id="img_modal" src="" width="100%" height="auto">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Required Jquery -->
    <script type="text/javascript" src="assets/js/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery-ui/jquery-ui.min.js "></script>
    <script type="text/javascript" src="assets/js/popper.js/popper.min.js"></script>
    <script type="text/javascript" src="assets/js/bootstrap/js/bootstrap.min.js "></script>
    <script type="text/javascript" src="assets/pages/widget/excanvas.js "></script>
    <!-- waves js -->
    <script src="assets/pages/waves/js/waves.min.js"></script>
    <!-- jquery slimscroll js -->
    <script type="text/javascript" src="assets/js/jquery-slimscroll/jquery.slimscroll.js "></script>
    <!-- modernizr js -->
    <script type="text/javascript" src="assets/js/modernizr/modernizr.js "></script>
    <!-- slimscroll js -->
    <script type="text/javascript" src="assets/js/SmoothScroll.js"></script>
    <script src="assets/js/jquery.mCustomScrollbar.concat.min.js "></script>
    <!-- Chart js -->
    <script type="text/javascript" src="assets/js/chart.js/Chart.js"></script>
    <!-- amchart js -->
    <script src="https://www.amcharts.com/lib/3/amcharts.js"></script>
    <script src="assets/pages/widget/amchart/gauge.js"></script>
    <script src="assets/pages/widget/amchart/serial.js"></script>
    <script src="assets/pages/widget/amchart/light.js"></script>
    <script src="assets/pages/widget/amchart/pie.min.js"></script>
    <script src="https://www.amcharts.com/lib/3/plugins/export/export.min.js"></script>
    <!-- menu js -->
    <script src="assets/js/pcoded.min.js"></script>
    <script src="assets/js/vertical-layout.min.js "></script>
    <!-- custom js -->
    <script type="text/javascript" src="assets/pages/dashboard/custom-dashboard.js"></script>
    <script type="text/javascript" src="assets/js/script.js "></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.11.3/datatables.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
    <script src="dist/Chart.bundle.js"></script>
    <script src="js/Plugin.Errorbars.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

</body>
<script>
    var table = null;
    var mySlider = null;
    var chart = {};
    var id = null;
    var phenodata = [];     // 피노타이핑 전체 데이터 저장
    var angleArr = [];      // 앵글 체크
    var labelArr = [];      // 라벨 체크
    var imageArr = {};      // 이미지 경로 저장 [angle][label] = "path"
    var imgDate = [];       // 선택 이미지 날짜 xxxx-xx-xx ~ yyyy-yy-yy
    var lineColor = {};     // 차트 라인 색상 저장
    var envirData = [];     // 환경정보 전체 데이터 저장
    var colorData = [];     // 선택 연구 색상 전체 데이터 저장
    const id_arr = ["table_div", "colorCard", "environmental_Information_card", "long_axis_card", "short_axis_card", "area_card", "convex_area_card", "center_x_card", "center_y_card"];
    const phenotypelabels = ["long_axis", "short_axis", "area", "convex_area", "center_x", "center_y"];
    const phenotype_AVG_labels = ["long_axis_average", "short_axis_average", "area_average", "convex_area_average", "center_x_average", "center_y_average"];
    
    $(function() { $("#res_stdate").datepicker({ dateFormat: 'yy-mm-dd' }); });
    $(function() { $("#res_eddate").datepicker({ dateFormat: 'yy-mm-dd' }); });


    // 체크박스 이벤트
    function selectAll(selectAll) {
        var name;
        var cnt = 0;
        if (selectAll == "angleButton") name = "angBox";
        else if (selectAll == "dataButton") name = "dataBox";
        else name = "labelBox";
        const checkboxes = document.querySelectorAll("input[name=" + name + "]");
        checkboxes.forEach((checkbox) => {
            $(checkbox).trigger("click");
        })
    }

    // 차트 생성
    function createChart(id) {
        var ctx = document.getElementById(id).getContext('2d');
        chart[id] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // 날짜
                datasets: [] // 라벨, 데이터
            },
            options: {
                tooltips: {
                        mode: "index",
                        intersect: false,
                    },
                    hover: {
                        mode: "nearest",
                        intersect: true,
                    },
                elements: {
                        point: {
                            radius: 0,
                        },
                    },
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    chartJsPluginErrorBars: {
                        width: 20
                    }
                }
            }
        });

        if (id == "environmental_Information") {
            chart[id].options = {
                tooltips: {
                            mode: "index",
                            intersect: false,
                        },
                hover: {
                    mode: "nearest",
                    intersect: true,
                },
                elements: {
                    point: {
                        radius: 0,
                    },
                },
                scales:{
                    xAxes: [
                        {
                        type: "time",
                            time: {
                                unit: "minute",
                                displayFormats: {
                                    minute: "MM-DD HH:mm",
                                },
                            },
                            ticks: {
                                autoSkip: true,
                                autoSkipPadding: 100,
                                maxRotation: 0,
                            },
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: "Date",
                            },
                        },
                    ],
                }
            };
        }
    }


    // 차트 카드 생성
    function createCard(id) {
        var html = "";
        html += `<div class="card" id="` + id + `_card">
                    <div class="card-header">
                        <h5>` + id + `</h5>
                        <button id="export_` + id + `" class="btn btn-primary waves-effect waves-light" style="float: right; padding-bottom: 3px; padding-top: 3px;">내보내기</button>
                    </div>
                    <div class="card-block">
                        <div class="collapse show" id="chart_` + id + `">
                            <div class="col" style="border: 1px solid lightgray; padding: 15px; margin-bottom: 5px;">
                                <canvas id="` + id + `" style="height: 35vh; width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>                                          
                </div>`

        $("#phenotypeCard").append(html);

        
    }


    // 선택 라벨 및 이벤트 생성
    function createLabel(label, angle) {
        $.each(label, (i, v) => {
            var html = "";
            html += `<label class="col-sm-3"><input type="checkbox" name="labelBox" id="` + v + `" value=""> ` + v + ` </label>`
            $("#label").append(html);

            $("#" + v).change(function(event) {
                if (labelArr.indexOf(this.id) == -1) labelArr.push(this.id);
                $.each(phenotypelabels, (i, v) => { if (chart[v] != undefined) updateChart(this, v); })
                updateImage(this);             
                envirUpdateChart();
            })
        })

        $.each(angle, (i, v) => {
            var html = "";
            var number = v.replace(/[^0-9]/g, '');
            html += `<label class="col-sm-2"><input type="checkbox" name="angBox" id="` + v + `"> ` + number + `° </label>`
            $("#angle").append(html);

            $("#" + v).change(function(event) {
                if (angleArr.indexOf(this.id) == -1 && this.checked) angleArr.push(this.id);
                $.each(phenotypelabels, (i, v) => { if (chart[v] != undefined) updateChart(this, v); })
                updateImage(this);        
                envirUpdateChart();
            })
        })
    }


    // 데이터, 날짜 삽입
    function SelectData(Angle, Label_Name, key, callback) {
        var data = []
        var date = []
        var path = []
        var timetmp = []
        $.each(phenodata, function(ind, val) {
            if (val["Angle"] == Angle && val['Label_Name'] == Label_Name) {
                if (timetmp.indexOf(val['time']) == -1) timetmp.push(val['time']);
            }
        })
        $.each(phenodata, function(ind, val) {
            if (val["Angle"] == Angle && val['Label_Name'] == Label_Name) {
                var index = timetmp.indexOf(val['time']);
                if (index != -1) data[index] = val[key];
                if (date.indexOf(val['time']) == -1) date.push(val['time'])
            }
        })
        callback(data, date)
    }


    function ShowImage(Imgsrc, Label) {
        $("#myModalLabel").text(Label);
        $("#img_modal").attr('src', Imgsrc);
        $("#myModal").modal("show");
    }


    // 이미지 테이블 생성
    function getImage(ind) {
        $('#imgTable').html("");
        var html = `<thead>
                        <tr>
                            <th>#</th>`;
        $.each(Object.keys(imageArr), (i2, v2) => {
            html += `<th style="text-align: center;">` + v2 + `</th>`;
        })
        html += `</tr>
            </thead>
            <tbody id="img_table_body"></tbody>`
        $('#imgTable').append(html);

        $.each(labelArr, (i2, v2) => {
            html = `<tr>
                <td style="vertical-align: inherit;">` + v2 + `</td>`;
            $.each(angleArr, (i3, v3) => {
                var imghtml = "";
                if (imageArr[v3][v2][mySlider.getValue()] != undefined) {
                    var tmp = imageArr[v3][v2][mySlider.getValue()].split("/")
                    var file = tmp[tmp.length - 1]
                    var resize_file = "/resize/resize_200_" + tmp[tmp.length - 1];
                    var templabel = resize_file.split("_");
                    imghtml = `<div class="form-group" onclick="ShowImage(\'http://phenome.iptime.org:23000/oldUsers` + imageArr[v3][v2][mySlider.getValue()].split("hdd1")[1] + `\',\'` + v2 + "_" + v3 + `\');" style="display: flex; flex-direction: column; align-items: center;">` +
                        `<img src="http://phenome.iptime.org:23000/users` + resize_file + `" width="200px" height="300px">
                        <label>` + (templabel[templabel.length - 1].split("."))[0] + `</label></div>`;
                } else imghtml = `<div style="display: flex; flex-direction: column; align-items: center;"><img src="" width="200px" height="300px"></div>`

                html += `<td>` + imghtml + `</td>`;
                if (angleArr.length - 1 == i3) {
                    html += `</tr>`;
                    $("#img_table_body").append(html);
                }
            })
        })
    }


    // 이미지 테이블 추가
    function updateImage(element) {
        var labelcheck = element;
        if (labelcheck.checked) {
            var leng = 0;
            var temp_id = [];
            imgDate = [];
            $.each(angleArr, (i, v) => {
                imageArr[v] = {};
                $.each(labelArr, (i2, v2) => {
                    var path = [];
                    imageArr[v][v2] = [];
                    $.each(phenodata, function(ind, val) {
                        if (val["Angle"] == v && val['Label_Name'] == v2) {
                            path.push(val['image']);
                            temp_id.push(val['imgid']);
                            if (imgDate.indexOf(val['time'].split("T")[0]) == -1) imgDate.push(val['time'].split("T")[0]);
                        }
                    })
                    if (path.length != 0) {
                        $.each(imgDate, (i3, v3) => {
                            if (path.length == 0) imageArr[v][v2].push(undefined);
                            else {
                                var temp = path[0].split("_");
                                if (temp[temp.length - 1].split(".")[0] == v3 && imageArr[v][v2].indexOf(path[0]) == -1) {
                                    imageArr[v][v2].push(path.shift());
                                } else imageArr[v][v2].push(undefined);
                            }
                        })
                    }
                    if (leng < imageArr[v][v2].length - 1) leng = imageArr[v][v2].length - 1;
                })
                if (angleArr.length - 1 == i) getImage(mySlider.getValue());
            })
            mySlider.options.max = leng;
        } else {
            if (labelcheck.name == "labelBox") {
                $.each(Object.keys(imageArr), (i, v) => {
                    $.each(Object.keys(imageArr[v]), (i2, v2) => { if (v2 == labelcheck.id) delete imageArr[v][v2]; })
                })
            } else {
                $.each(Object.keys(imageArr), (i, v) => { if (v == labelcheck.id) delete imageArr[v]; })
            }
            getImage(mySlider.getValue());
        }
    }


    // 차트 데이터 추가
    function updateChart(element, id) {
        var labelcheck = element;
        if (labelcheck.checked) {
            chart[id].config.data.labels = [];
            chart[id].config.data.datasets = [];
            $.each(labelArr, function(i, v) {
                if (lineColor[v] == undefined) { lineColor[v] = Math.floor(Math.random() * 361) + "_" + Math.floor(Math.random() * 101); }
                $.each(angleArr, function(i2, v2) {
                    var hsl = "hsl(" + lineColor[v].split("_")[0] + ", " + lineColor[v].split("_")[1]  + "%, " + (((Number(v2.split("SV")[1]) / 18) * 4) + 20) + "%)"
                    SelectData(v2, v, id, function(data, date) {
                        var newDataset = {
                            label: v + "_" + v2,
                            backgroundColor: hsl,
                            borderColor: hsl,
                            data: data,
                            fill: false,
                            tension: 0,
                            errorBars: {}
                        }
                        chart[id].config.data.datasets.push(newDataset);
                        if (chart[id].config.data.labels.length != date.length) chart[id].config.data.labels = date;
                        chart[id].update();
                    })
                })
                if (labelArr.length - 1 == i) updateErrorBars(id);
            })

            chart[id].update();
        } else {
            do {
                var ind = chart[id].config.data.datasets
                    .findIndex((v, i) => {
                        if (labelcheck.name == "labelBox") return (v.label.split("_")[0] + "_" + v.label.split("_")[1] + "_" + v.label.split("_")[2]) == labelcheck.id;
                        else return (v.label.split("_")[3] + "_" + v.label.split("_")[4]) == labelcheck.id;
                    })
                if (ind != -1) {
                    chart[id].config.data.datasets.splice(ind, 1);
                    chart[id].update();
                }
            } while (ind != -1);
            if (labelcheck.name == "labelBox" && labelArr.indexOf(labelcheck.id) != -1) labelArr.splice(labelArr.indexOf(labelcheck.id), 1);
            else if (labelcheck.name == "angBox" && angleArr.indexOf(labelcheck.id) != -1) angleArr.splice(angleArr.indexOf(labelcheck.id), 1);
            updateErrorBars(id);
        }
    }


    // 날짜 사이 모든 날짜 추출
    function getDatesStartToLast(startDate, lastDate) {
        var regex = RegExp(/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/);
        if(!(regex.test(startDate) && regex.test(lastDate))) return "Not Date Format";
        var result = [];
        var curDate = new Date(startDate);
        while(curDate <= new Date(lastDate)) {
            result.push(curDate.toISOString().split("T")[0]);
            curDate.setDate(curDate.getDate() + 1);
        }
        return result;
    }


    // 환경정보 차트 생성
    function envirUpdateChart() {
        var label = ["temperature°C", "humidity%", "insolation%"]
        if (imgDate.length != 0) {
            chart["environmental_Information"].config.data.labels = [];
            chart["environmental_Information"].config.data.datasets = [];
            var data = {};
            data[0] = [];
            data[1] = [];
            data[2] = [];

            $.each(envirData, (i, v) => {
                if (imgDate[0] <= v.time.split("T")[0] && v.time.split("T")[0] <= imgDate[imgDate.length - 1] && (v.time.split(":")[1] == '00')) {
                    data[0].push({x:v.time, y:v.temp})
                    data[1].push({x:v.time, y:v.hum})
                    data[2].push({x:v.time, y:v.insol + ((Math.random() * 10) + 10)})
                }
            })
            var newDataset = [{
                label: label[0],
                backgroundColor: "hsl(0, 0%, 0%)",
                borderColor: "hsl(0, 0%, 0%)",
                data: data[0],
                fill: false,
                errorBars: {}
            },
            {
                label: label[1],
                backgroundColor: "hsl(50, 50%, 50%)",
                borderColor: "hsl(50, 50%, 50%)",
                data: data[1],
                fill: false,
                errorBars: {}
            },
            {
                label: label[2],
                backgroundColor: "hsl(125, 50%, 50%)",
                borderColor: "hsl(125, 50%, 50%)",
                data: data[2],
                fill: false,
                errorBars: {}
            },
        ]
            
        chart["environmental_Information"].config.data.datasets = newDataset;
        chart["environmental_Information"].config.data.labels = getDatesStartToLast(imgDate[0], imgDate[imgDate.length - 1]);       
        chart["environmental_Information"].update();
        }
    }


    // 평균, 표준편차 차트 생성
    function updateErrorBars(id) {
        var chartLength = chart[id].config.data.datasets.length;
        chart[id + "_average"].config.data.labels = [];
        chart[id + "_average"].config.data.datasets = [];
        $.each(labelArr, (ind, val) => {
            var avg = [];
            var stddev = {};
            $.each(chart[id].config.data.labels, (i, v) => {
                var data = [];
                stddev[v] = {};
                $.each(chart[id].config.data.datasets, (i2, v2) => {
                    if (v2.data[i] != undefined && v2.label.split("VIS")[0] == (val + "_")) data.push(v2.data[i]);
                    if (chart[id].config.data.datasets.length - 1 == i2) {
                        avg.push(d3.mean(data));
                        if (data.length > 1) {
                            stddev[v]["plus"] = d3.deviation(data);
                            stddev[v]["minus"] = -d3.deviation(data);
                        }
                    }
                })
                if (chart[id].config.data.labels.length - 1 == i) {
                    var hsl = "hsl(" + lineColor[val].split("_")[0] + ", " + lineColor[val].split("_")[1]  + "%, 50%)"
                    var newDataset = {
                        label: val + "_average",
                        backgroundColor: hsl,
                        borderColor: hsl,
                        data: avg,
                        fill: false,
                        tension: 0,
                        errorBars: stddev,
                    }
                    chart[id + "_average"].config.data.datasets.push(newDataset);
                    chart[id + "_average"].config.data.labels = chart[id].config.data.labels;
                }
            })
        })
        chart[id + "_average"].update();
    }


    // 색상 차트 생성
    function updateColorChart() {      
        chart["colorChart"].config.data.labels = [];
        chart["colorChart"].config.data.datasets = [];
        chart["colorChart"].options.elements.point.radius = 6;
        $.each(labelArr, (i, v) => {
            $.each(angleArr, (i2, v2) => {
                var greendata = [];
                var yellowdata = [];
                $.each(imageArr[v2][v], (i3, v3) => {
                    var index = colorData.findIndex((val, ind) => { 
                        if (v3 != undefined) return val.val.name == v3.split("/")[v3.split("/").length - 1]; 
                        else return -1;
                    })

                    if (index != -1) {
                        var gsum = 0;
                        var ysum = 0;
                        for (var ind = hueGreen.getValue()[0]; ind <= hueGreen.getValue()[1]; ind++) { gsum += Number(colorData[index].val[ind]); }
                        for (var ind = hueYellow.getValue()[0]; ind <= hueYellow.getValue()[1]; ind++) { ysum += Number(colorData[index].val[ind]); }
                        greendata.push(gsum);
                        yellowdata.push(ysum);
                    }
                    else {
                        greendata.push(0);
                        yellowdata.push(0);
                    }
                })
                var hsl = "hsl(" + lineColor[v].split("_")[0] + ", " + lineColor[v].split("_")[1]  + "%, " + (((Number(v2.split("SV")[1]) / 18) * 4) + 20) + "%)"
                var newDatasetGreen = {
                    label: v + "_" + v2 + "_Green",
                    backgroundColor: hsl,
                    borderColor: hsl,
                    data: greendata,
                    fill: false,
                    strokeColor: hsl,
                    pointBackgroundColor: "rgb(0, 128, 0)",
                    tension: 0,
                }           
                var newDatasetYellow = {
                    label: v + "_" + v2 + "_Yellow",
                    backgroundColor: hsl,
                    borderColor: hsl,
                    data: yellowdata,
                    fill: false,
                    strokeColor: hsl,
                    pointBackgroundColor: "rgb(255, 255, 0)",
                    tension: 0,
                }
                chart["colorChart"].config.data.datasets.push(newDatasetGreen);
                chart["colorChart"].config.data.datasets.push(newDatasetYellow);
                chart["colorChart"].config.data.labels = imgDate;
            })
        })
        chart["colorChart"].update();
    }



    function downloadChart(id) {
        console.log("download "+id +" Chart")
        var url = document.createElement("a"); 
        url.href = chart[id].toBase64Image();
        url.download = id + "_chart.png";
        console.log(id);
        url.click();
    }

    window.onload = function() {
        // 연구 설정 - 보기 선택 클릭 이벤트
        $.each(id_arr, function(i, v) {
            $("#datacheck_" + (i + 1)).on('click', function() {
                if ($("#datacheck_" + (i + 1)).prop('checked')) {
                    if ($(':radio[name="radio_btn"]:checked').val() == 1 || i < 3) $("#" + v).css("display", "block");      
                    else $("#" + v.split("_card")[0] + "_average_card").css("display", "block"); 
                }
                else {
                    if ($(':radio[name="radio_btn"]:checked').val() == 1 || i < 3) $("#" + v).css("display", "none");
                    else $("#" + v.split("_card")[0] + "_average_card").css("display", "none");
                }
            })
        })


        

        // hue/이미지 슬라이더 생성 및 체인지 이벤트
        hueGreen = new Slider("#hueGreen", {
            min: 0,
            max: 255,
            step: 1,
            value: [40, 80],
            formatter: function(value) { return "Hue : [" + value[0] + ", " + value[1] + "]"; }
        });
        hueYellow = new Slider("#hueYellow", {
            min: 0,
            max: 255,
            step: 1,
            value: [23, 40],
            formatter: function(value) { return "Hue : [" + value[0] + ", " + value[1] + "]"; }
        });
        mySlider = new Slider("#ex6", {
            value: 0,
            min: 0,
            max: 0,
            step: 1,
            formatter: function(value) {
                if (imgDate.length == 0) return value;
                else return imgDate[value];
            }
        });
        mySlider.on('change', function(event) { getImage(event.newValue); })

        // 개별보기/평균보기 체인지 이벤트 
        $(':radio[name="radio_btn"]').change(function(event) {
            if (this.value == 1) {
                $.each(phenotypelabels, (i, v) => { 
                    if ($("#datacheck_" + (id_arr.indexOf(v + "_card") + 1)).prop('checked')) {
                        $("#" + v + "_card").css("display", "block"); 
                        $("#" + v + "_average_card").css("display", "none"); 
                    }
                })
            } else {
                $.each(phenotype_AVG_labels, (i, v) => {
                    if ($("#datacheck_" + (id_arr.indexOf(v.split("_average")[0] + "_card") + 1)).prop('checked')) {
                        $("#" + v + "_card").css("display", "block");
                        $("#" + v.split("_average")[0] + "_card").css("display", "none"); 
                    }
                })
            }
        })


        // 클 요청(연구id 전달) -> 서버 수치데이터 전달 -> 클 가져옴
        var par = location.search.substr(location.search.indexOf("?") + 1);
        id = par.split("=")[1];
        $.ajax({
            url: "/onloadChart",
            method: "post",
            data: { res_id: id },
            success: function(data) {
                $("#table_body").html("");
                table = $("#tableId").DataTable({
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel'
                    ]
                });
                table.clear();
                var label = [];
                var angle = [];

                $.each(data, (i, v) => {
                    table.row.add([
                        (i + 1),
                        v["Label_Name"],
                        v["Angle"],
                        v["long_axis"],
                        v["short_axis"],
                        v["area"],
                        v["convex_area"],
                        v["center_x"],
                        v["center_y"],
                    ]);
                    phenodata.push({
                        imgid : v["ImageID"],
                        Label_Name: v["Label_Name"],
                        Angle: v["Angle"],
                        long_axis: v["long_axis"],
                        short_axis: v["short_axis"],
                        area: v["area"],
                        convex_area: v["convex_area"],
                        center_x: v["center_x"],
                        center_y: v["center_y"],
                        time: v["time"],
                        image: v["Image_Path"],
                    });

                    if (data.length - 1 == i) table.draw();
                    if (angle.indexOf(v["Angle"]) == -1) angle.push(v["Angle"]);
                    if (label.indexOf(v["Label_Name"]) == -1) label.push(v["Label_Name"]);
                })
                angle.sort();
                label.sort();
                $("#label").html("");

                $.each(phenotypelabels, (i, v) => {
                    createCard(v);
                    createChart(v);
                    console.log("#export_"+v);
                    $("#export_" + v).on('click', function(){ downloadChart(v); });
                    $("#" + v + "_card").css("display", "none");
                })
                $.each(phenotype_AVG_labels, (i ,v) => {
                    createCard(v);
                    createChart(v);
                    $("#" + v + "_card").css("display", "none");
                })
                createCard("environmental_Information");
                createChart("environmental_Information");
                createChart("colorChart");
                $("#table_div").css("display", "none");
                $("#colorCard").css("display", "none");
                $("#" + "environmental_Information" + "_card").css("display", "none");         
                createLabel(label, angle);
            }
        });


        // 클 요청(연구id 전달) -> 서버(환경정보) 전달 -> 클 가져옴
        $.ajax({    
            url: "/onloadEnvir",
            method: "post",
            data: { res_id: id },
            success: function(data) {
                $.each(data, (i, v) => {
                    envirData.push({
                        temp : v["temp"],
                        hum : v["hum"],
                        insol : v["insol"],
                        time : v["time"]
                    })
                    if (data.length - 1 == i) envirData = envirData.sort(function (a, b) { return new Date(a.time) - new Date(b.time); })
                })
            }
        })

        // 클 요청 -> 서버(색상) 전달 -> 클 가져옴
        $.ajax({
            url: "/onloadColor",
            method : "post",
            success: function(data) {
                $.each(data, (i, v) => {
                    colorData.push({
                        imgid: v["imgid"],
                        val: JSON.parse(v["val"])
                    })
                    if (data.length - 1 == i) colorData = colorData.sort(function (a, b) { return a.imgid - b.imgid; })
                })
                
            }
        })
    }
</script>
</html>